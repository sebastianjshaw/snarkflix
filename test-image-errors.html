<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Image Error Handling Test</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .test-image { width: 200px; height: 200px; border: 1px solid #ccc; margin: 10px; }
        .snarkflix-image-error { opacity: 0.5; filter: grayscale(100%); background: #f5f5f5; border: 2px dashed #999; }
        .snarkflix-image-failed { opacity: 0.3; filter: grayscale(100%); background: #f5f5f5; border: 2px dashed #999; min-height: 200px; display: flex; align-items: center; justify-content: center; }
    </style>
</head>
<body>
    <h1>Image Error Handling Test</h1>
    <p>This page tests the image error handling to ensure no infinite retry loops.</p>
    
    <h2>Test 1: Non-existent image (should retry twice then show placeholder)</h2>
    <img src="non-existent-image.jpg" alt="Test image" class="test-image">
    
    <h2>Test 2: Another non-existent image</h2>
    <img src="another-fake-image.png" alt="Test image 2" class="test-image">
    
    <h2>Test 3: Valid image (should load normally)</h2>
    <img src="images/site-assets/logo.avif" alt="Valid logo" class="test-image">
    
    <script>
        // Copy the fixed error handling function
        function handleImageError(img, fallbackSrc = 'images/site-assets/logo.avif') {
            console.warn('Image failed to load:', img.src);
            
            // Prevent infinite retry loops
            const retryCount = img.dataset.retryCount || 0;
            const maxRetries = 2;
            
            if (retryCount >= maxRetries) {
                console.error('Max retries reached for image:', img.src);
                img.src = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjZjVmNWY1Ii8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIxNCIgZmlsbD0iIzk5OSIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPkltYWdlIG5vdCBhdmFpbGFibGU8L3RleHQ+PC9zdmc+';
                img.alt = 'Image not available';
                img.classList.add('snarkflix-image-error');
                img.classList.add('snarkflix-image-failed');
                return;
            }
            
            // Increment retry count
            img.dataset.retryCount = parseInt(retryCount) + 1;
            
            // Try fallback
            img.src = fallbackSrc;
            img.alt = 'Image not available';
            img.classList.add('snarkflix-image-error');
        }
        
        function handleImageLoad(img) {
            img.classList.remove('snarkflix-image-error');
            img.classList.add('snarkflix-image-loaded');
        }
        
        // Set up error handling
        document.addEventListener('DOMContentLoaded', function() {
            const images = document.querySelectorAll('img');
            images.forEach(img => {
                img.addEventListener('error', () => handleImageError(img));
                img.addEventListener('load', () => handleImageLoad(img));
            });
        });
    </script>
</body>
</html>
